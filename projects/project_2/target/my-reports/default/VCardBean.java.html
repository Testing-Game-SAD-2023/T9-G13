<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>VCardBean.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">T92</a> &gt; <a href="index.source.html" class="el_package">default</a> &gt; <span class="el_source">VCardBean.java</span></div><h1>VCardBean.java</h1><pre class="source lang-java linenums">
import java.io.Serializable;
import java.util.NoSuchElementException;
import java.util.StringTokenizer;

/**
 * Represents VCard data.
 */
<span class="fc" id="L9">public class VCardBean implements Serializable {</span>
    private String vCard;

    // Name fields
    private String firstName;
    private String lastName;
    private String middleName;
    private String formattedName;

    private String title;
    private String organization;
    private String email;
    private String phone;
    private String fax;


    public void setVCard(String vCard) {
<span class="fc" id="L26">        this.vCard = vCard;</span>

<span class="fc" id="L28">        firstName = lastName = middleName = formattedName = null;</span>
<span class="fc" id="L29">        title = null;</span>
<span class="fc" id="L30">        organization = null;</span>
<span class="fc" id="L31">        email = null;</span>
<span class="fc" id="L32">        phone = fax = null;</span>

<span class="fc" id="L34">        parseVCard(this);</span>
<span class="fc" id="L35">    }</span>

    /**
     * @return A String representation of this vCard object.  If a
     *         vCard cannot be found or generated, this will return
     *         null.
     */
    public String getVCard() {
        String ret;
<span class="fc bfc" id="L44" title="All 2 branches covered.">        if(null == vCard) {</span>
            // tries to generate a vcard for this object
            // (this may return null if a vcard cannot be generated)
<span class="fc" id="L47">            ret = generateVCard(this);</span>
        } else {
<span class="fc" id="L49">            ret = vCard;</span>
        }
<span class="fc" id="L51">        return ret;</span>
    }

    public String getFirstName() {
<span class="fc" id="L55">        return firstName;</span>
    }

    public void setFirstName(String firstName) {
<span class="fc" id="L59">        this.firstName = firstName;</span>
<span class="fc" id="L60">    }</span>

    public String getLastName() {
<span class="fc" id="L63">        return lastName;</span>
    }

    public void setLastName(String lastName) {
<span class="fc" id="L67">        this.lastName = lastName;</span>
<span class="fc" id="L68">    }</span>

    public String getMiddleName() {
<span class="fc" id="L71">        return middleName;</span>
    }

    public void setMiddleName(String middleName) {
<span class="fc" id="L75">        this.middleName = middleName;</span>
<span class="fc" id="L76">    }</span>

    public String getFormattedName() {
<span class="fc" id="L79">        return formattedName;</span>
    }

    public void setFormattedName(String formattedName) {
<span class="fc" id="L83">        this.formattedName = formattedName;</span>
<span class="fc" id="L84">    }</span>

    public String getTitle() {
<span class="fc" id="L87">        return title;</span>
    }

    public void setTitle(String title) {
<span class="fc" id="L91">        this.title = title;</span>
<span class="fc" id="L92">    }</span>

    public String getOrganization() {
<span class="fc" id="L95">        return organization;</span>
    }

    public void setOrganization(String organization) {
<span class="fc" id="L99">        this.organization = organization;</span>
<span class="fc" id="L100">    }</span>

    public String getEmail() {
<span class="fc" id="L103">        return email;</span>
    }

    public void setEmail(String email) {
<span class="fc" id="L107">        this.email = email;</span>
<span class="fc" id="L108">    }</span>

    public String getPhone() {
<span class="fc" id="L111">        return phone;</span>
    }

    public void setPhone(String phone) {
<span class="fc" id="L115">        this.phone = phone;</span>
<span class="fc" id="L116">    }</span>

    public String getFax() {
<span class="fc" id="L119">        return fax;</span>
    }

    public void setFax(String fax) {
<span class="fc" id="L123">        this.fax = fax;</span>
<span class="fc" id="L124">    }</span>

    public String toString() {
<span class="fc" id="L127">        return getVCard();</span>
    }

    /**
     * Generates a vCard String from the various member variables. If no
     * vCard can be generated, it returns null.
     * 
     * DESIGN DECISION: Since this is used primarily to generate vCards
     * inputted via contribute and/or imported records, there are extra
     * restrictions beyond the N and FN (name fields) requirements for
     * a vCard -- to generate a vcard we additionally require an EMAIL,
     * an ORG, and a TITLE.
     */
    private static String generateVCard(VCardBean vcb) {
        // Makes sure required fields are there
<span class="fc bfc" id="L142" title="All 6 branches covered.">        if(null == vcb.getFirstName() || null == vcb.getLastName() || null == vcb.getEmail()</span>
<span class="pc bpc" id="L143" title="1 of 2 branches missed.">                || null == vcb.getOrganization()) {</span>
<span class="fc" id="L144">            return null;</span>
        }
<span class="nc" id="L146">        StringBuffer vCard = new StringBuffer(&quot;BEGIN:VCARD\n&quot;);</span>

        // FN field
        {
            StringBuffer name;
<span class="nc bnc" id="L151" title="All 2 branches missed.">            if(vcb.getFormattedName() != null) {</span>
<span class="nc" id="L152">                name = new StringBuffer(vcb.getFormattedName());</span>
            } else {
<span class="nc" id="L154">                name = new StringBuffer(vcb.getFirstName()).append(&quot; &quot;);</span>
<span class="nc" id="L155">                String middleName = vcb.getMiddleName();</span>
<span class="nc bnc" id="L156" title="All 4 branches missed.">                if(middleName != null &amp;&amp; middleName.length() != 0) {</span>
<span class="nc" id="L157">                    name.append(middleName).append(&quot; &quot;);</span>
                }
<span class="nc" id="L159">                name.append(vcb.getLastName());</span>
            }
<span class="nc" id="L161">            vCard.append(&quot;FN:&quot;).append(name.toString()).append(&quot;\n&quot;);</span>
        }

        // N field
<span class="nc" id="L165">        vCard.append(&quot;N:&quot;).append(vcb.getLastName()).append(&quot;;&quot;);</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">        if(vcb.getMiddleName() != null) {</span>
<span class="nc" id="L167">            vCard.append(vcb.getMiddleName());</span>
        }
<span class="nc" id="L169">        vCard.append(&quot;;&quot;).append(vcb.getFirstName()).append(&quot;;&quot;).append(&quot;\n&quot;);</span>

        // TITLE field
<span class="nc bnc" id="L172" title="All 2 branches missed.">        if(null != vcb.getTitle()) {</span>
<span class="nc" id="L173">            vCard.append(&quot;TITLE:&quot;).append(addBackslashes(vcb.getTitle())).append(&quot;\n&quot;);</span>
        }

        // ORG field
<span class="nc" id="L177">        vCard.append(&quot;ORG:&quot;).append(addBackslashes(vcb.getOrganization())).append(&quot;\n&quot;);</span>

        // EMAIL field
<span class="nc" id="L180">        vCard.append(&quot;EMAIL;TYPE=INTERNET:&quot;).append(vcb.getEmail()).append(&quot;\n&quot;);</span>

        // TEL;TYPE=VOICE field
<span class="nc bnc" id="L183" title="All 4 branches missed.">        if(vcb.getPhone() != null &amp;&amp; vcb.getPhone().length() != 0) {</span>
<span class="nc" id="L184">            vCard.append(&quot;TEL;TYPE=VOICE:&quot;).append(vcb.getPhone()).append(&quot;\n&quot;);</span>
        }

        // TEL;TYPE=FAX field
<span class="nc bnc" id="L188" title="All 4 branches missed.">        if(vcb.getFax() != null &amp;&amp; vcb.getFax().length() != 0) {</span>
<span class="nc" id="L189">            vCard.append(&quot;TEL;TYPE=FAX:&quot;).append(vcb.getFax()).append(&quot;\n&quot;);</span>
        }

<span class="nc" id="L192">        vCard.append(&quot;END:VCARD&quot;);</span>
<span class="nc" id="L193">        return vCard.toString();</span>
//        this.vCard = vCard.toString();
    }

    /**
     * Folds lines which are more than 75 characters long into multiple lines
     * delimited by &quot;\r\n\t&quot; (a CRLF + a whitespace character).
     *
     * @param str An unfolded String.
     *
     * @return A folded String.
     */
    private static String foldLines(String str) {
<span class="nc" id="L206">        StringBuffer ret = new StringBuffer();</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">        while(str.length() &gt; 75) {</span>
<span class="nc" id="L208">            ret.append(str.substring(0, 75) + &quot;\r\n\t&quot;);</span>
<span class="nc" id="L209">            str = str.substring(75, str.length());</span>
        }
<span class="nc" id="L211">        ret.append(str);</span>
<span class="nc" id="L212">        return ret.toString();</span>
    }

    /**
     * If lines are folded using a CRLF + a whitespace character, this unfolds
     * the line in the String.
     *
     * @param str A String with folded lines.
     *
     * @return A String without folded lines.
     */
    private static String unfoldLines(String str) {
<span class="nc" id="L224">        return str.replaceAll(&quot;\r\n\\s&quot;, &quot;&quot;);</span>
    }

    /**
     * Takes what's in the vCard field and seperates it out to the seperate
     * vCard variables.  If the vCard is valid for our purposes, we set the
     * VCardBean properties accordingly.
     */
    private static void parseVCard(VCardBean vcb) {
<span class="fc" id="L233">        String vCard = vcb.getVCard();</span>
<span class="pc bpc" id="L234" title="2 of 4 branches missed.">        if(null == vCard || !vCard.toUpperCase().startsWith(&quot;BEGIN:VCARD&quot;)) {</span>
<span class="fc" id="L235">            return;</span>
        }

<span class="nc" id="L238">        vCard = unfoldLines(vCard);</span>
<span class="nc" id="L239">        StringTokenizer tokenizer = new StringTokenizer(vCard, &quot;\n&quot;);</span>

        // Basic vCard types
<span class="nc" id="L242">        String FN = null;</span>
<span class="nc" id="L243">        String N = null;</span>
<span class="nc" id="L244">        String ORG = null;</span>
<span class="nc" id="L245">        String EMAIL = null;</span>
<span class="nc" id="L246">        String TEL = null;</span>
<span class="nc" id="L247">        String TITLE = null;</span>
<span class="nc" id="L248">        String TEL_FAX = null;</span>

<span class="nc" id="L250">        boolean beginFound = false;</span>
<span class="nc" id="L251">        boolean endFound = false;</span>
<span class="nc bnc" id="L252" title="All 4 branches missed.">        while(tokenizer.hasMoreElements() &amp;&amp; !endFound) {</span>
<span class="nc" id="L253">            String element = (String)tokenizer.nextElement();</span>

<span class="nc" id="L255">            int index = element.indexOf(&quot;:&quot;);</span>

            // Malformed vCard, so reset the field data and return without setting
            // the VCardBean properties
<span class="nc bnc" id="L259" title="All 2 branches missed.">            if(index == -1) {</span>
<span class="nc" id="L260">                return;</span>
            }

<span class="nc bnc" id="L263" title="All 2 branches missed.">            if(index == element.length() - 1) {</span>
<span class="nc" id="L264">                continue;</span>
            }

<span class="nc" id="L267">            String type = element.substring(0, index);</span>
<span class="nc" id="L268">            String data = element.substring(index + 1, element.length());</span>
<span class="nc" id="L269">            String subtype = &quot;&quot;;</span>

            // Checks for subtypes
<span class="nc bnc" id="L272" title="All 2 branches missed.">            if((index = type.indexOf(&quot;;&quot;)) != -1) {</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">                if(index + 1 != type.length()) {</span>
<span class="nc" id="L274">                    subtype = type.substring(index + 1, type.length());</span>
                }
<span class="nc" id="L276">                type = type.substring(0, index);</span>
            }

            // Cleans up the strings
<span class="nc" id="L280">            type = type.trim();</span>
<span class="nc" id="L281">            data = data.trim();</span>

            // Looks for the beginning of the vCard, which should be the first element
<span class="nc bnc" id="L284" title="All 2 branches missed.">            if(!beginFound) {</span>
<span class="nc bnc" id="L285" title="All 4 branches missed.">                if(type.equalsIgnoreCase(&quot;begin&quot;) &amp;&amp; data.equalsIgnoreCase(&quot;vcard&quot;)) {</span>
<span class="nc" id="L286">                    beginFound = true;</span>
                }
                continue;
            }

            // Looks for the end element
<span class="nc bnc" id="L292" title="All 4 branches missed.">            if(type.equalsIgnoreCase(&quot;end&quot;) &amp;&amp; data.equalsIgnoreCase(&quot;vcard&quot;)) {</span>
<span class="nc" id="L293">                endFound = true;</span>
<span class="nc" id="L294">                continue;</span>
            }

            // FN type
<span class="nc bnc" id="L298" title="All 2 branches missed.">            if(type.equalsIgnoreCase(&quot;fn&quot;)) {</span>
<span class="nc" id="L299">                FN = data;</span>
<span class="nc" id="L300">                continue;</span>
            }

            // N type
<span class="nc bnc" id="L304" title="All 2 branches missed.">            if(type.equalsIgnoreCase(&quot;n&quot;)) {</span>
<span class="nc" id="L305">                N = data;</span>
<span class="nc" id="L306">                continue;</span>
                
            }

            // ORG type
<span class="nc bnc" id="L311" title="All 2 branches missed.">            if(type.equalsIgnoreCase(&quot;org&quot;)) {</span>
<span class="nc" id="L312">                ORG = data;</span>
<span class="nc" id="L313">                continue;</span>
            }

            // EMAIL type
<span class="nc bnc" id="L317" title="All 2 branches missed.">            if(type.equalsIgnoreCase(&quot;email&quot;)) {</span>
<span class="nc" id="L318">                EMAIL = data;</span>
<span class="nc" id="L319">                continue;</span>
            }

            // TEL type
<span class="nc bnc" id="L323" title="All 2 branches missed.">            if(type.equalsIgnoreCase(&quot;tel&quot;)) {</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">                if(&quot;type=fax&quot;.equalsIgnoreCase(subtype)) {</span>
<span class="nc" id="L325">                    TEL_FAX = data;</span>
                } else {
<span class="nc" id="L327">                    TEL = data;</span>
                }
<span class="nc" id="L329">                continue;</span>
            }

            // TITLE type
<span class="nc bnc" id="L333" title="All 2 branches missed.">            if(type.equalsIgnoreCase(&quot;title&quot;)) {</span>
<span class="nc" id="L334">                TITLE = data;</span>
<span class="nc" id="L335">                continue;</span>
            }
<span class="nc" id="L337">        } // end loop</span>


        // Parses vCard into the seperate fields

        // this doesn't take into account \;'s which should be escaped, but
        // this is only a partial implementation of vcard so for now we don't worry about it 
<span class="nc bnc" id="L344" title="All 2 branches missed.">        if (N != null)</span>
        {
<span class="nc" id="L346">          String[] name = N.split(&quot;;&quot;);</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">          if(name.length &gt;= 3) {</span>
<span class="nc" id="L348">            vcb.setFirstName(name[2].trim());</span>
<span class="nc" id="L349">            vcb.setMiddleName(name[1].trim());</span>
<span class="nc" id="L350">            vcb.setLastName(name[0].trim());</span>
          }
        }
        
<span class="nc bnc" id="L354" title="All 2 branches missed.">        if(null != FN) {</span>
<span class="nc" id="L355">            vcb.setFormattedName(FN.trim());</span>
        }

<span class="nc bnc" id="L358" title="All 2 branches missed.">        if(null != ORG) {</span>
<span class="nc" id="L359">            vcb.setOrganization(removeBackslashes(ORG.trim()));</span>
        }
<span class="nc bnc" id="L361" title="All 2 branches missed.">        if(null != EMAIL) {</span>
<span class="nc" id="L362">            vcb.setEmail(EMAIL.trim());</span>
        }
<span class="nc bnc" id="L364" title="All 2 branches missed.">        if(null != TITLE) {</span>
<span class="nc" id="L365">            vcb.setTitle(removeBackslashes(TITLE.trim()));</span>
        }

<span class="nc bnc" id="L368" title="All 2 branches missed.">        if(TEL != null) {</span>
<span class="nc" id="L369">            vcb.setPhone(TEL.trim());</span>
        }

<span class="nc bnc" id="L372" title="All 2 branches missed.">        if(null != TEL_FAX) {</span>
<span class="nc" id="L373">            vcb.setFax(TEL_FAX.trim());</span>
        }
<span class="nc" id="L375">    }</span>

    /**
     * Adds escape characters (backslashes) to characters with special meaning in vCard attributres.
     *
     * @param str
     *
     * @return The string with backslashes added before commas and semicolons.
     */
    private static String addBackslashes(String str) {
<span class="nc" id="L385">        return str.replaceAll(&quot;,&quot;, &quot;\\,&quot;).replaceAll(&quot;;&quot;, &quot;\\;&quot;);</span>
    }

    /**
     * Removes escape characters (backslashes) from characters with special meaning in vCard attributes.
     * Used when translating a vCard String
     *
     * @param str
     *
     * @return The String with backslashes removed from before commas and semicolons.
     */
    private static String removeBackslashes(String str) {
<span class="nc" id="L397">        return str.replaceAll(&quot;\\,&quot;, &quot;,&quot;).replaceAll(&quot;\\;&quot;, &quot;;&quot;);</span>
    }

    public boolean isValidVCard() {
<span class="fc bfc" id="L401" title="All 2 branches covered.">        return (null == vCard ? false : vCard.toLowerCase().startsWith(&quot;begin:vcard&quot;));</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>